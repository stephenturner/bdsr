<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.313">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Stephen D. Turner, Ph.D.">
<title>Biological Data Science with R - 10&nbsp; Predictive Analytics: Predicting and Forecasting Influenza</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./textmining.html" rel="next">
<link href="./survival.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./stats.html">Electives</a></li><li class="breadcrumb-item"><a href="./predmodeling.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Predictive Analytics: Predicting and Forecasting Influenza</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Biological Data Science with R</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/stephenturner/bdsr" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Download" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download"><i class="bi bi-download"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Biological-Data-Science-with-R.pdf">
              <i class="bi bi-bi-file-pdf pe-1"></i>
            Download PDF
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="./Biological-Data-Science-with-R.epub">
              <i class="bi bi-bi-journal pe-1"></i>
            Download ePub
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Core Curriculum</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tibbles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tibbles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dplyr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Manipulation with dplyr</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidyr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Tidy Data and Advanced Data Manipulation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ggplot2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Visualization with ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tidyeda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Refresher: Tidy Exploratory Data Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Reproducible Reporting with RMarkdown</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Electives</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Essential statistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./survival.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Survival Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predmodeling.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Predictive Analytics: Predicting and Forecasting Influenza</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./textmining.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Text Mining and NLP</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rnaseq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count-Based Differential Expression Analysis of RNA-seq Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ggtree.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Visualizing and Annotating Phylogenetic Trees</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Setup</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Further Resources</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#predictive-modeling" id="toc-predictive-modeling" class="nav-link active" data-scroll-target="#predictive-modeling"><span class="header-section-number">10.1</span> Predictive Modeling</a>
  <ul class="collapse">
<li><a href="#h7n9-outbreak-data" id="toc-h7n9-outbreak-data" class="nav-link" data-scroll-target="#h7n9-outbreak-data"><span class="header-section-number">10.1.1</span> H7N9 Outbreak Data</a></li>
  <li><a href="#importing-h7n9-data" id="toc-importing-h7n9-data" class="nav-link" data-scroll-target="#importing-h7n9-data"><span class="header-section-number">10.1.2</span> Importing H7N9 data</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis"><span class="header-section-number">10.1.3</span> Exploratory data analysis</a></li>
  <li><a href="#feature-extraction" id="toc-feature-extraction" class="nav-link" data-scroll-target="#feature-extraction"><span class="header-section-number">10.1.4</span> Feature Extraction</a></li>
  <li><a href="#imputation" id="toc-imputation" class="nav-link" data-scroll-target="#imputation"><span class="header-section-number">10.1.5</span> Imputation</a></li>
  <li><a href="#the-caret-package" id="toc-the-caret-package" class="nav-link" data-scroll-target="#the-caret-package"><span class="header-section-number">10.1.6</span> The caret package</a></li>
  <li><a href="#model-training" id="toc-model-training" class="nav-link" data-scroll-target="#model-training"><span class="header-section-number">10.1.7</span> Model training</a></li>
  <li><a href="#prediction-on-unknown-samples" id="toc-prediction-on-unknown-samples" class="nav-link" data-scroll-target="#prediction-on-unknown-samples"><span class="header-section-number">10.1.8</span> Prediction on unknown samples</a></li>
  </ul>
</li>
  <li>
<a href="#forecasting" id="toc-forecasting" class="nav-link" data-scroll-target="#forecasting"><span class="header-section-number">10.2</span> Forecasting</a>
  <ul class="collapse">
<li><a href="#the-prophet-package" id="toc-the-prophet-package" class="nav-link" data-scroll-target="#the-prophet-package"><span class="header-section-number">10.2.1</span> The Prophet Package</a></li>
  <li><a href="#cdc-ili-time-series-data" id="toc-cdc-ili-time-series-data" class="nav-link" data-scroll-target="#cdc-ili-time-series-data"><span class="header-section-number">10.2.2</span> CDC ILI time series data</a></li>
  <li><a href="#forecasting-with-prophet" id="toc-forecasting-with-prophet" class="nav-link" data-scroll-target="#forecasting-with-prophet"><span class="header-section-number">10.2.3</span> Forecasting with prophet</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"><span id="sec-predmodeling" class="quarto-section-identifier"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Predictive Analytics: Predicting and Forecasting Influenza</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>This chapter will provide hands-on instruction for using machine learning algorithms to predict a disease outcome. We will cover data cleaning, feature extraction, imputation, and using a variety of models to try to predict disease outcome. We will use resampling strategies to assess the performance of predictive modeling procedures such as Random Forest, stochastic gradient boosting, elastic net regularized regression (LASSO), and k-nearest neighbors. We will also demonstrate demonstrate how to <em>forecast</em> future trends given historical infectious disease surveillance data using methodology that accounts for seasonality and nonlinearity.</p>
<p><strong>Handout</strong>: <a href="handouts/r-predictive-modeling.pdf">Predictive Modeling Handout</a>.</p>
<section id="predictive-modeling" class="level2" data-number="10.1"><h2 data-number="10.1" class="anchored" data-anchor-id="predictive-modeling">
<span class="header-section-number">10.1</span> Predictive Modeling</h2>
<p>Here we’re going to use some epidemiological data collected during an influenza A (H7N9) outbreak in China in 2013. Of 134 cases with data, 31 died, 46 recovered, but 57 cases do not have a recorded outcome. We’ll develop models capable of predicting death or recovery from the unlabeled cases. Along the way, we will:</p>
<ul>
<li>Do some exploratory data analysis and data visualization to get an overall sense of the data we have.</li>
<li>Extract and recode <em>features</em> from the raw data that are more amenable to data mining / machine learning algorithms.</li>
<li>Impute missing data points from some of the predictor variables.</li>
<li>Use a framework that enables consistent access to hundreds of classification and regression algorithms, and that facilitates automated parameter tuning using bootstrapping-based resampling for model assessment.</li>
<li>We will develop models using several different approaches (Random Forest, stochastic gradient boosting, elastic net regularized logistic regression, <em>k</em>-nearest neighbor) by training and testing the models on the data where the outcome is known</li>
<li>We will compare the performance of each of the models and apply the best to predict the outcome for cases where we didn’t know the outcome.</li>
</ul>
<section id="h7n9-outbreak-data" class="level3" data-number="10.1.1"><h3 data-number="10.1.1" class="anchored" data-anchor-id="h7n9-outbreak-data">
<span class="header-section-number">10.1.1</span> H7N9 Outbreak Data</h3>
<p>The data we’re using here is from the 2013 outbreak of <a href="https://en.wikipedia.org/wiki/Influenza_A_virus_subtype_H7N9">influenza A H7N9 in China</a>, analyzed by Kucharski et al., published in 2014.</p>
<blockquote class="blockquote">
<p><strong>Publication</strong>: A. Kucharski, H. Mills, A. Pinsent, C. Fraser, M. Van Kerkhove, C. A. Donnelly, and S. Riley. 2014. Distinguishing between reservoir exposure and human-to-human transmission for emerging pathogens using case onset data. <a href="http://doi.org/10.1371/currents.outbreaks.e1473d9bfc99d080ca242139a06c455f"><em>PLOS Currents Outbreaks</em> (2014) Mar 7 Edition 1</a>.</p>
</blockquote>
<blockquote class="blockquote">
<p><strong>Data</strong>: Kucharski A, Mills HL, Pinsent A, Fraser C, Van Kerkhove M, Donnelly CA, Riley S (2014) Data from: Distinguishing between reservoir exposure and human-to-human transmission for emerging pathogens using case onset data. <em>Dryad Digital Repository</em>. https://doi.org/10.5061/dryad.2g43n.</p>
</blockquote>
<p>The data is made available in the <a href="https://cran.r-project.org/web/packages/outbreaks/index.html">outbreaks</a> package, which is a collection of several simulated and real outbreak datasets, and has been very <a href="https://github.com/bioconnector/workshops/blame/master/r-predictive-flu.Rmd#L20">slightly modified</a> for use here. The analysis we’ll do here is inspired by and modified in part from a <a href="https://shiring.github.io/machine_learning/2016/11/27/flu_outcome_ML_post">similar analysis by Shirin Glander</a>.</p>
<p>There are two datasets available in <a href="data/data.zip">data.zip</a>:</p>
<ol type="1">
<li>
<strong><a href="data/h7n9.csv">h7n9.csv</a></strong>: The original dataset. Contains the following variables, with lots of missing data throughout.
<ul>
<li>
<strong><code>case_id</code></strong>: the sample identifier</li>
<li>
<strong><code>date_onset</code></strong>: date of onset of syptoms</li>
<li>
<strong><code>date_hospitalization</code></strong>: date the patient was hospitalized, if available</li>
<li>
<strong><code>date_outcome</code></strong>: date the outcome (recovery, death) was observed, if available</li>
<li>
<strong><code>outcome</code></strong>: “Death” or “Recover,” if available</li>
<li>
<strong><code>gender</code></strong>: male (m) or female (f)</li>
<li>
<strong><code>age</code></strong>: age of the individual, if known</li>
<li>
<strong><code>province</code></strong>: either Shanghai, Jiangsu, Zhejiang, or Other (lumps together less common provinces)</li>
</ul>
</li>
<li>
<strong><a href="data/h7n9_analysisready.csv">h7n9_analysisready.csv</a></strong>: The “analysis-ready” dataset. This data has been cleaned up, with some “feature extraction” / variable recoding done to make the data more suitable to data mining / machine learning methods used here. We still have the outcome variable, either <em>Death</em>, <em>Recover</em> or unknown (NA).
<ul>
<li>
<strong><code>case_id</code></strong>: <em>(same as above)</em>
</li>
<li>
<strong><code>outcome</code></strong>: <em>(same as above)</em>
</li>
<li>
<strong><code>age</code></strong>: <em>(same as above, imputed if unknown)</em>
</li>
<li>
<strong><code>male</code></strong>: Instead of sex (m/f), this is a 0/1 indicator, where 1=male, 0=female.</li>
<li>
<strong><code>hospital</code></strong>: Indicator variable whether or not the patient was hospitalized</li>
<li>
<strong><code>days_to_hospital</code></strong>: The number of days between onset and hospitalization</li>
<li>
<strong><code>days_to_outcome</code></strong>: The number of days between onset and outcome (if available)</li>
<li>
<strong><code>early_outcome</code></strong>: Whether or not the outcome was recorded prior to the median date of the outcome in the dataset</li>
<li>
<strong><code>Jiangsu</code></strong>: Indicator variable: 1 = the patient was from the Jiangsu province.</li>
<li>
<strong><code>Shanghai</code></strong>: Indicator variable: 1 = the patient was from the Shanghai province.</li>
<li>
<strong><code>Zhejiang</code></strong>: Indicator variable: 1 = the patient was from the Zhejiang province.</li>
<li>
<strong><code>Other</code></strong>: Indicator variable: 1 = the patient was from some other less common province.</li>
</ul>
</li>
</ol></section><section id="importing-h7n9-data" class="level3" data-number="10.1.2"><h3 data-number="10.1.2" class="anchored" data-anchor-id="importing-h7n9-data">
<span class="header-section-number">10.1.2</span> Importing H7N9 data</h3>
<p>First, let’s load the packages we’ll need initially.</p>
<div class="cell" data-hash="predmodeling_cache/html/loadPkgs_ba3c118f40a15fb6e0f7ef2e5843ca12">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s read in the data and take a look. Notice that it correctly read in the dates as date-formatted variables. Later on, when we run functions such as <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code> on a date variable, it knows how to handle that properly. You’ll also notice that there are missing values throughout.</p>
<div class="cell" data-hash="predmodeling_cache/html/importH7N9_e5cf3f48d733fb5b062e715a461768f4">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Read in data</span></span>
<span><span class="va">flu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/h7n9.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View in RStudio (capital V)</span></span>
<span><span class="co"># View(flu)</span></span>
<span></span>
<span><span class="co"># Take a look</span></span>
<span><span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 134 × 8
   case_id date_onset date_hospitalization date_outcome outcome gender   age
   &lt;chr&gt;   &lt;date&gt;     &lt;date&gt;               &lt;date&gt;       &lt;chr&gt;   &lt;chr&gt;  &lt;dbl&gt;
 1 case_1  2013-02-19 NA                   2013-03-04   Death   m         58
 2 case_2  2013-02-27 2013-03-03           2013-03-10   Death   m          7
 3 case_3  2013-03-09 2013-03-19           2013-04-09   Death   f         11
 4 case_4  2013-03-19 2013-03-27           NA           &lt;NA&gt;    f         18
 5 case_5  2013-03-19 2013-03-30           2013-05-15   Recover f         20
 6 case_6  2013-03-21 2013-03-28           2013-04-26   Death   f          9
 7 case_7  2013-03-20 2013-03-29           2013-04-09   Death   m         54
 8 case_8  2013-03-07 2013-03-18           2013-03-27   Death   m         14
 9 case_9  2013-03-25 2013-03-25           NA           &lt;NA&gt;    m         39
10 case_10 2013-03-28 2013-04-01           2013-04-03   Death   m         20
# ℹ 124 more rows
# ℹ 1 more variable: province &lt;chr&gt;</code></pre>
</div>
</div>
</section><section id="exploratory-data-analysis" class="level3" data-number="10.1.3"><h3 data-number="10.1.3" class="anchored" data-anchor-id="exploratory-data-analysis">
<span class="header-section-number">10.1.3</span> Exploratory data analysis</h3>
<p>Let’s use ggplot2 to take a look at the data. Refer back to the visualization section (<a href="ggplot2.html">Chapter&nbsp;<span>5</span></a>) if you need a refresher.</p>
<p>The <strong>outcome</strong> variable is the thing we’re most interested in here – it’s the thing we want to eventually predict for the unknown cases. Let’s look at the distribution of that outcome variable (Death, Recover or unknown (NA)), by <strong>age</strong>. We’ll create a density distribution looking at age, with the fill of the distribution colored by outcome status.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-2_eb88693bd1d8f494fe9e498d94baccd6">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">outcome</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s look at the counts of the number of deaths, recoveries, and unknowns by sex, then separately by province.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-3_e8ee135340c357b004d34c4091618eb5">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">outcome</span><span class="op">)</span>, position<span class="op">=</span><span class="st">"dodge"</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can simply add a <code>facet_wrap</code> to split by province.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-4_17d0912fb97ef868a64f15459abafa7a">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">gender</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">outcome</span><span class="op">)</span>, position<span class="op">=</span><span class="st">"dodge"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">province</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s draw a boxplot showing the age distribution by province, by outcome. This shows that there’s a higher rate of death in older individuals but this is only observed in Jiangsu and Zhejiang provinces.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-5_77e26602449ffcecf2878d519334fc76">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># First just by age</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">province</span>, <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Then by age and outcome</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">province</span>, <span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let’s try something a little bit more advanced. First, take a look at the data again.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-6_3cfc902d895ba5a76d61693f24dbc668">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice how we have three different date variables: date of onset, hospitalization, and outcome. I’d like to draw a plot showing the date on the x-axis with a line connecting the three points from onset, to hospitalization, to outcome (if known) for each patient. I’ll put age on the y-axis so the individuals are separated, and I’ll do this faceted by province.</p>
<p>First we need to use the <code>gather</code> function from the <strong>tidyr</strong> package to gather up all the <code>date_?</code> variables into a single column we’ll call <code>key</code>, with the actual values being put into a new column called <code>date</code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-7_2f2cc1153e932cf5e59186f467da4760">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Gather the date columns</span></span>
<span><span class="va">flugather</span> <span class="op">&lt;-</span> <span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="va">key</span>, <span class="va">date</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"date_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Look at the data as is</span></span>
<span><span class="co"># flugather</span></span>
<span></span>
<span><span class="co"># Better: Show the data arranged by case_id so you see the three entries</span></span>
<span><span class="va">flugather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">case_id</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 402 × 7
   case_id  outcome gender   age province key                  date      
   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;                &lt;date&gt;    
 1 case_1   Death   m         58 Shanghai date_onset           2013-02-19
 2 case_1   Death   m         58 Shanghai date_hospitalization NA        
 3 case_1   Death   m         58 Shanghai date_outcome         2013-03-04
 4 case_10  Death   m         20 Shanghai date_onset           2013-03-28
 5 case_10  Death   m         20 Shanghai date_hospitalization 2013-04-01
 6 case_10  Death   m         20 Shanghai date_outcome         2013-04-03
 7 case_100 &lt;NA&gt;    m         30 Zhejiang date_onset           2013-04-16
 8 case_100 &lt;NA&gt;    m         30 Zhejiang date_hospitalization NA        
 9 case_100 &lt;NA&gt;    m         30 Zhejiang date_outcome         NA        
10 case_101 &lt;NA&gt;    f         51 Zhejiang date_onset           2013-04-13
# ℹ 392 more rows</code></pre>
</div>
</div>
<p>Now that we have this, let’s visualize the number of days that passed between onset, hospitalization and outcome, for each case. We see that there are lots of unconnected points, especially in Jiangsu and Zhejiang provinces, where one of these dates isn’t known.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-8_4d0d7bf2a8f4f6a9dd8cc4ebe1120f1c">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">flugather</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">date</span>, y<span class="op">=</span><span class="va">age</span>, color<span class="op">=</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group<span class="op">=</span><span class="va">case_id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">province</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section><section id="feature-extraction" class="level3" data-number="10.1.4"><h3 data-number="10.1.4" class="anchored" data-anchor-id="feature-extraction">
<span class="header-section-number">10.1.4</span> Feature Extraction</h3>
<p>The variables in our data are useful for summary statistics, visualization, EDA, etc. But we need to do some <em>feature extraction</em> or variable recoding to get the most out of machine learning models.</p>
<ul>
<li>Age: we’ll keep this one as is.</li>
<li>Gender: instead of m/f, let’s convert this into a binary indicator variable where 0=female, 1=male.</li>
<li>Province: along the same lines, let’s create binary classifiers that indicate Shanghai, Zhejiang, Jiangsu, or other provinces.</li>
<li>Hospitalization: let’s create a binary classifier where 0=not hospitalized, 1=hospitalized.</li>
<li>Dates: Let’s also take the <em>dates</em> of onset, hospitalization, and outcome, and transform these into <em>days</em> between onset and hospitalization, and days from onset to outcome. The algorithms aren’t going to look at one column then another to do this math – we have to extract this feature ourselves.</li>
<li>Early outcome: let’s create another binary 0/1 indicating whether someone had an early outcome (earlier than the median outcome date observed).</li>
</ul>
<p>Let’s build up this pipeline one step at a time. If you want to skip ahead, you can simply read in the already extracted/recoded/imputed dataset at <a href="data/h7n9_analysisready.csv"><code>data/h7n9_analysisready.csv</code></a>.</p>
<p>First, let’s make a backup of the original data in case we mess something up.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-9_eb57990d69dabf0e0b494c221c9c9243">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu_orig</span> <span class="op">&lt;-</span> <span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="create-gender-hospitalization-indicators" class="level4" data-number="10.1.4.1"><h4 data-number="10.1.4.1" class="anchored" data-anchor-id="create-gender-hospitalization-indicators">
<span class="header-section-number">10.1.4.1</span> Create gender / hospitalization indicators</h4>
<p>Now let’s start recoding, one step at a time. First of all, when we mutate to add a new variable, we can put in a logical comparison to tell us whether a statement is TRUE or FALSE. For example, let’s look at the gender variable.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-10_5634fd7d735ac819c20344b3005722ed">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span><span class="op">$</span><span class="va">gender</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can ask if gender is male (“m”) like this:</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-11_1b08bf615b66d333631a30a0897a4a90">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span><span class="op">$</span><span class="va">gender</span><span class="op">==</span><span class="st">"m"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So we can do that with a mutate statement on a pipeline. Once we do that, we can remove the old gender variable. E.g.:</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-12_2d99314b3f7f4c2cda7639a52e47fa41">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>male <span class="op">=</span> <span class="va">gender</span><span class="op">==</span><span class="st">"m"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">gender</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Similarly, let’s get an indicator whether someone was hospitalized or not. If hospitalization is missing, this would return TRUE. If you want to ask whether they are <em>not</em> missing, you would use <code>!</code> to negate the logical question, i.e., <code>!is.na(flu$date_hospitalization)</code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-13_e03fc832f9b0b1a11bde66133c048b25">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span><span class="op">$</span><span class="va">date_hospitalization</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">flu</span><span class="op">$</span><span class="va">date_hospitalization</span><span class="op">)</span></span>
<span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">flu</span><span class="op">$</span><span class="va">date_hospitalization</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So now, let’s add that to our pipeline from above.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-14_ef622e6d9ec9115fb367aed0a821a527">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>male <span class="op">=</span> <span class="va">gender</span><span class="op">==</span><span class="st">"m"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">gender</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_hospitalization</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="convert-dates-to-days-to-___" class="level4" data-number="10.1.4.2"><h4 data-number="10.1.4.2" class="anchored" data-anchor-id="convert-dates-to-days-to-___">
<span class="header-section-number">10.1.4.2</span> Convert dates to “days to ___”</h4>
<p>Let’s continue to add days from onset to hospitalization and days to outcome by subtracting one date from the other, and converting the value to numeric. We’ll also create an early outcome binary variable indicating whether the date of the outcome was less than the median, after removing missing variables. We’ll finally remove all the variables that start with “date.” Finally, we’ll use the <code>mutate_if</code> function, which takes a predicate and an action function. We’ll ask – <em>if</em> the variable is logical (TRUE/FALSE), turn it into an integer (1/0).</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-15_52927e42428955862fe135123349e82d">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># What's the median outcome date?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">flu</span><span class="op">$</span><span class="va">date_outcome</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the whole pipeline</span></span>
<span><span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>male <span class="op">=</span> <span class="va">gender</span><span class="op">==</span><span class="st">"m"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">gender</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_hospitalization</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_to_hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_hospitalization</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_to_outcome  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_outcome</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>early_outcome <span class="op">=</span> <span class="va">date_outcome</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">date_outcome</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span><span class="op">(</span><span class="va">is.logical</span>, <span class="va">as.integer</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once you’re satisfied your pipeline works, reassign the pipeline back to the <code>flu</code> object itself (remember, we created the backup above in case we messed something up here).</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-16_9ed0ae99cdb4b05f353b89edb859043a">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Make the assignment</span></span>
<span><span class="va">flu</span> <span class="op">&lt;-</span> <span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>male <span class="op">=</span> <span class="va">gender</span><span class="op">==</span><span class="st">"m"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">gender</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hospital <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">date_hospitalization</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_to_hospital <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_hospitalization</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>days_to_outcome  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">date_outcome</span> <span class="op">-</span> <span class="va">date_onset</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>early_outcome <span class="op">=</span> <span class="va">date_outcome</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">date_outcome</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">starts_with</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span><span class="op">(</span><span class="va">is.logical</span>, <span class="va">as.integer</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Take a look</span></span>
<span><span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 134 × 9
   case_id outcome   age province  male hospital days_to_hospital
   &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;    &lt;int&gt;            &lt;dbl&gt;
 1 case_1  Death      58 Shanghai     1        0               NA
 2 case_2  Death       7 Shanghai     1        1                4
 3 case_3  Death      11 Other        0        1               10
 4 case_4  &lt;NA&gt;       18 Jiangsu      0        1                8
 5 case_5  Recover    20 Jiangsu      0        1               11
 6 case_6  Death       9 Jiangsu      0        1                7
 7 case_7  Death      54 Jiangsu      1        1                9
 8 case_8  Death      14 Zhejiang     1        1               11
 9 case_9  &lt;NA&gt;       39 Zhejiang     1        1                0
10 case_10 Death      20 Shanghai     1        1                4
# ℹ 124 more rows
# ℹ 2 more variables: days_to_outcome &lt;dbl&gt;, early_outcome &lt;int&gt;</code></pre>
</div>
</div>
</section><section id="create-indicators-for-province" class="level4" data-number="10.1.4.3"><h4 data-number="10.1.4.3" class="anchored" data-anchor-id="create-indicators-for-province">
<span class="header-section-number">10.1.4.3</span> Create indicators for province</h4>
<p>Now, there’s one more thing we want to do. Instead of a single “province” variable that has multiple levels, we want to do the dummy coding ourselves. When we ran regression models R handled this internally without our intervention. But we need to be explicit here. Here’s one way to do it.</p>
<p>First, there’s a built-in function called <code>model.matrix</code> that creates dummy codes. You have to give it a formula like you do in linear models, but here, I give it a <code>~0+variable</code> syntax so that it doesn’t try to create an intercept. That is, instead of <em>k-1</em> dummy variables, it’ll create <em>k</em>. Try it.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-17_0263a653b215873a9bfc1e884cfb39f7">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="fl">0</span><span class="op">+</span><span class="va">province</span>, data<span class="op">=</span><span class="va">flu</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There’s another built-in function called <code>cbind</code> that binds columns together. This can be dangerous to use if you’re not certain that rows are in the same order (there, it’s better to use an inner join). But here, we’re certain they’re in the same order. Try binding the results of that to the original data.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-18_32dcbdc5ff13cf4f82fd125b263ab64d">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="fl">0</span><span class="op">+</span><span class="va">province</span>, data<span class="op">=</span><span class="va">flu</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, turn it into a tibble and select out the original province variable. Once you’ve run the pipeline, go back and make the assignment back to the <code>flu</code> object itself.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-19_b58c17e8bed2e1b99db92914d8d11826">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">flu</span>, <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="fl">0</span><span class="op">+</span><span class="va">province</span>, data<span class="op">=</span><span class="va">flu</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">province</span><span class="op">)</span></span>
<span><span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 134 × 12
   case_id outcome   age  male hospital days_to_hospital days_to_outcome
   &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;    &lt;int&gt;            &lt;dbl&gt;           &lt;dbl&gt;
 1 case_1  Death      58     1        0               NA              13
 2 case_2  Death       7     1        1                4              11
 3 case_3  Death      11     0        1               10              31
 4 case_4  &lt;NA&gt;       18     0        1                8              NA
 5 case_5  Recover    20     0        1               11              57
 6 case_6  Death       9     0        1                7              36
 7 case_7  Death      54     1        1                9              20
 8 case_8  Death      14     1        1               11              20
 9 case_9  &lt;NA&gt;       39     1        1                0              NA
10 case_10 Death      20     1        1                4               6
# ℹ 124 more rows
# ℹ 5 more variables: early_outcome &lt;int&gt;, provinceJiangsu &lt;dbl&gt;,
#   provinceOther &lt;dbl&gt;, provinceShanghai &lt;dbl&gt;, provinceZhejiang &lt;dbl&gt;</code></pre>
</div>
</div>
<p><em>Optional</em>: Notice how the new variables are provinceJiangsu, provinceOther, provinceShanghai, provinceZhejiang. If we want to strip off the “province” we can do that. There’s a built-in command called <code>gsub</code> that can help here. Take a look at the help for <code><a href="https://rdrr.io/r/base/grep.html">?gsub</a></code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-20_b6b6af1f64c34bbc901b47c66eb5f9c3">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Take a look at the names of the flu dataset.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flu</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove "province"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"province"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flu</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now make the assignment back to names(flu)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flu</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"province"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">flu</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Take a look</span></span>
<span><span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="imputation" class="level3" data-number="10.1.5"><h3 data-number="10.1.5" class="anchored" data-anchor-id="imputation">
<span class="header-section-number">10.1.5</span> Imputation</h3>
<p>We have a lot of missing data points throughout. Most of the data mining algorithms we’re going to use later can’t handle missing data, so observations with any missing data are excluded from the model completely. If we have a large dataset and only a few missing values, it’s probably better to exclude them and proceed. But since we’ve already got a pretty low number of observations, we need to try to impute missing values to maximize our use of the data we have.</p>
<p>There are lots of different imputation approaches. An overly simplistic method is simply a mean or median imputation – you simply plug in the mean value for that column for the missing sample’s value. This leaves the mean unchanged (good) but artificially decreases the variance (not good). We’re going to use the <strong>mice</strong> package for imputation (Multivariate Imputation by Chained Equations). This package gives you functions that can impute continuous, binary, and ordered/unordered categorical data, imputing each incomplete variable with a separate model. It tries to account for relations in the data and uncertainty about those relationships. The methods are described in the paper.</p>
<blockquote class="blockquote">
<p>Buuren, S., &amp; Groothuis-Oudshoorn, K. (2011). mice: Multivariate imputation by chained equations in R. <a href="https://www.jstatsoft.org/article/view/v045i03"><em>Journal of statistical software</em>, 45(3)</a>.</p>
</blockquote>
<p>Let’s load the mice package, and take a look at our data again.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-21_236e7f6c666e363472d62b444f46d8f3">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/amices/mice">mice</a></span><span class="op">)</span></span>
<span><span class="va">flu</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 134 × 12
   case_id outcome   age  male hospital days_to_hospital days_to_outcome
   &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;    &lt;int&gt;            &lt;dbl&gt;           &lt;dbl&gt;
 1 case_1  Death      58     1        0               NA              13
 2 case_2  Death       7     1        1                4              11
 3 case_3  Death      11     0        1               10              31
 4 case_4  &lt;NA&gt;       18     0        1                8              NA
 5 case_5  Recover    20     0        1               11              57
 6 case_6  Death       9     0        1                7              36
 7 case_7  Death      54     1        1                9              20
 8 case_8  Death      14     1        1               11              20
 9 case_9  &lt;NA&gt;       39     1        1                0              NA
10 case_10 Death      20     1        1                4               6
# ℹ 124 more rows
# ℹ 5 more variables: early_outcome &lt;int&gt;, Jiangsu &lt;dbl&gt;, Other &lt;dbl&gt;,
#   Shanghai &lt;dbl&gt;, Zhejiang &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Eventually we want to predict the outcome, so we don’t want to factor that into the imputation. We also don’t want to factor in the case ID, because that’s just an individual’s identifier. So let’s create a new dataset selecting out those two variables so we can try to impute everything else.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-22_6f325ee525339e1e2ca3fca86e4b00be">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code><a href="https://amices.org/mice/reference/mice.html">mice()</a></code> function itself returns a special kind of object called a multiply imputed data set, and from this we can run mice’s <code><a href="https://tidyr.tidyverse.org/reference/complete.html">complete()</a></code> on the thing returned by <code><a href="https://amices.org/mice/reference/mice.html">mice()</a></code> to complete the dataset that was passed to it. Here’s what we’ll do. We’ll take the flu data, select out the first two columns, create the imputation, then complete the original data, assigning that to a new dataset called <code>fluimp</code>. First let’s set the random number seed generator to some number (use the same as I do if you want identical results).</p>
<div class="cell" data-hash="predmodeling_cache/html/mice_5c9520764594f0713524a081a3e963a5">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">fluimp</span> <span class="op">&lt;-</span> <span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://amices.org/mice/reference/mice.html">mice</a></span><span class="op">(</span>print<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/complete.html">complete</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fluimp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we need to put the data back together again. We do this by selecting the original two columns from the original flu data, and then using <code><a href="https://amices.org/mice/reference/cbind.html">cbind()</a></code> like above to mash the two datasets together side by side. Finally, we’ll turn it back into a tibble. Once you’ve run the pipeline and you like the result, assign it back to <code>fluimp</code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-23_cd7a550857494b1d30cac80fc9cbc212">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Run the pipeline successfully first before you reassign!</span></span>
<span><span class="va">fluimp</span> <span class="op">&lt;-</span> <span class="va">flu</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://amices.org/mice/reference/cbind.html">cbind</a></span><span class="op">(</span><span class="va">fluimp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fluimp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 134 × 12
   case_id outcome   age  male hospital days_to_hospital days_to_outcome
   &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;    &lt;int&gt;            &lt;dbl&gt;           &lt;dbl&gt;
 1 case_1  Death      58     1        0                7              13
 2 case_2  Death       7     1        1                4              11
 3 case_3  Death      11     0        1               10              31
 4 case_4  &lt;NA&gt;       18     0        1                8              38
 5 case_5  Recover    20     0        1               11              57
 6 case_6  Death       9     0        1                7              36
 7 case_7  Death      54     1        1                9              20
 8 case_8  Death      14     1        1               11              20
 9 case_9  &lt;NA&gt;       39     1        1                0              18
10 case_10 Death      20     1        1                4               6
# ℹ 124 more rows
# ℹ 5 more variables: early_outcome &lt;int&gt;, Jiangsu &lt;dbl&gt;, Other &lt;dbl&gt;,
#   Shanghai &lt;dbl&gt;, Zhejiang &lt;dbl&gt;</code></pre>
</div>
</div>
<p>At this point we’re almost ready to do some predictive modeling! If you didn’t make it this far and you just want to read in the analysis ready dataset, you can do that too.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-24_b53472699ccdcad22074b7c956bc6c89">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fluimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/h7n9_analysisready.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="the-caret-package" class="level3" data-number="10.1.6"><h3 data-number="10.1.6" class="anchored" data-anchor-id="the-caret-package">
<span class="header-section-number">10.1.6</span> The caret package</h3>
<p>We’re going to use the <strong>caret</strong> package for building and testing predictive models using a variety of different data mining / ML algorithms. The package was published in JSS in 2008. Max Kuhn’s <a href="https://www.r-project.org/conferences/useR-2013/Tutorials/kuhn/user_caret_2up.pdf">slides from the 2013 useR! conference</a> are also a great resource, as is the <a href="https://cran.r-project.org/web/packages/caret/vignettes/caret.pdf">caret package vignette</a>, and the <a href="http://topepo.github.io/caret/">detailed e-book documentation</a>.</p>
<blockquote class="blockquote">
<p>Kuhn, M. (2008). Building Predictive Models in R Using the caret Package. <em>Journal of Statistical Software</em>, 28(5), 1 - 26. doi: <a href="http://dx.doi.org/10.18637/jss.v028.i05" class="uri">http://dx.doi.org/10.18637/jss.v028.i05</a></p>
</blockquote>
<p>The <a href="http://cran.r-project.org/web/packages/caret/index.html"><strong>caret</strong></a> package (short for <strong>C</strong>lassification <strong>A</strong>nd <strong>RE</strong>gression <strong>T</strong>raining) is a set of functions that streamline the process for creating and testing a wide variety of predictive models with different resampling approaches, as well as estimating variable importance from developed models. There are many different modeling functions in R spread across many different packages, and they all have different syntax for model training and/or prediction. The <strong>caret</strong> package provides a uniform interface the functions themselves, as well as a way to standardize common tasks (such parameter tuning and variable importance).</p>
<p>The <code>train</code> function from caret is used to:</p>
<ul>
<li>evaluate, using resampling, the effect of model tuning parameters on performance</li>
<li>choose the “optimal” model across these parameters</li>
<li>estimate model performance from a training set</li>
</ul>
<section id="models-available-in-caret" class="level4" data-number="10.1.6.1"><h4 data-number="10.1.6.1" class="anchored" data-anchor-id="models-available-in-caret">
<span class="header-section-number">10.1.6.1</span> Models available in caret</h4>
<p>First you have to choose a specific type of model or algorithm. Currently there are <strong>239</strong> different algorithms implemented in caret. Caret provides the interface to the method, but you still need the external package installed. For example, we’ll be fitting a Random Forest model, and for that we’ll need the <a href="https://cran.r-project.org/package=randomForest">randomForest</a> package installed. You can see all the methods that you can deploy by looking at the help for train.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-26_bf4793b3c8ee5f0b5d055a006f009c29">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/topepo/caret/">caret</a></span><span class="op">)</span></span>
<span><span class="op">?</span><span class="va">train</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From here, click on the link to see the <a href="http://topepo.github.io/caret/available-models.html">available models</a> or <a href="http://topepo.github.io/caret/train-models-by-tag.html">models by tag</a>. From here you can search for particular models by name. We’re going to fit models using Random Forest, stochastic gradient boosting, k-Nearest Neighbors, Lasso and Elastic-Net Regularized Generalized Linear Models. These require the packages <a href="https://cran.r-project.org/package=randomForest">randomForest</a>, <a href="https://cran.r-project.org/package=gbm">gbm</a>, <a href="https://cran.r-project.org/package=kknn">kknn</a>, and <a href="https://cran.r-project.org/package=glmnet">glmnet</a>, respectively.</p>
<p>Each of the models may have one or more <em>tuning parameters</em> – some value or option you can set to tweak how the algorithm develops. In k-nearest neighbors, we can try different values of <em>k</em>. With random forest, we can set the <span class="math inline">\(m_{\text{try}}\)</span> option – the algorithm will select <span class="math inline">\(m_{\text{try}}\)</span> number of predictors to attempt a split for classification. Caret attempts to do this using a procedure like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/caret-pseudocode.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><em>The caret model training algorithm. Image from the caret paper.</em></figcaption><p></p>
</figure>
</div>
<p>That is, it sweeps through each possible parameter you can set for the particular type of model you choose, and uses some kind of resampling scheme with your training data, fitting the model on a subset and testing on the held-out samples.</p>
</section><section id="resampling" class="level4" data-number="10.1.6.2"><h4 data-number="10.1.6.2" class="anchored" data-anchor-id="resampling">
<span class="header-section-number">10.1.6.2</span> Resampling</h4>
<p>The default resampling scheme caret uses is the <a href="https://en.wikipedia.org/wiki/Bootstrapping_(statistics)">bootstrap</a>. Bootstrapping takes a random sample <em>with replacement</em> from your data that’s the same size of the original data. Samples might be selected more than once, and some aren’t selected at all. On average, each sample has a ~63.2% chance of showing up at least once in a bootstrap sample. Some samples won’t show up at all, and these <em>held out</em> samples are the ones that are used for testing the performance of the trained model. You repeat this process many times (e.g., 25, 100, etc) to get an average performance estimate on unseen data. Here’s what it looks like in practice.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/caret-bootstrap.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><em>Bootstrapping schematic. Image from Max Kuhn’s 2013 useR! talk.</em></figcaption><p></p>
</figure>
</div>
<p>Many alternatives exist. Another popular approach is cross-validation. Here, a subset of your data (e.g., 4/5ths, or 80%) is used for training, and the remaining 1/5th or 20% is used for performance assessment. You slide the cross-validation interval over and use the next 4/5ths for training and 1/5th for testing. You do this again for all 5ths of the data. You can optionally repeat this process many times (<em>repeated cross-validation</em>) to get an average cross validation prediction accuracy for a given model and set of tuning parameters.</p>
<p>The <code>trainControl</code> option in the <code>train</code> function controls this, and you can learn more about this under the <a href="http://topepo.github.io/caret/model-training-and-tuning.html#basic-parameter-tuning">Basic Parameter Tuning</a> section of the caret documentation.</p>
</section></section><section id="model-training" class="level3" data-number="10.1.7"><h3 data-number="10.1.7" class="anchored" data-anchor-id="model-training">
<span class="header-section-number">10.1.7</span> Model training</h3>
<p>Let’s try it out! If you didn’t make it through the data preprocessing steps and you just want to read in the analysis ready dataset, you can do this:</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-27_f92b94ea366535a84a1bb1e55157ee4a">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fluimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/h7n9_analysisready.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="splitting-data-into-known-and-unknown-outcomes" class="level4" data-number="10.1.7.1"><h4 data-number="10.1.7.1" class="anchored" data-anchor-id="splitting-data-into-known-and-unknown-outcomes">
<span class="header-section-number">10.1.7.1</span> Splitting data into known and unknown outcomes</h4>
<p>Before we continue, let’s split the dataset into samples where we know the outcome, and those where we don’t. The unknown samples will be the ones where <code>is.na(outcome)</code> is TRUE. So you can use a filter statement.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-28_ca90b56515896386e11cb149360dfc1d">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Run the pipeline successfully first before you reassign!</span></span>
<span><span class="co"># These are samples with unknown data we'll use later to predict</span></span>
<span><span class="va">unknown</span> <span class="op">&lt;-</span> <span class="va">fluimp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">unknown</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The known samples are the cases where <code>!is.na(outcome)</code> is TRUE, that is, cases where the outcome is not (<code>!</code>) missing. One thing we want to do here while we’re at it is remove the case ID. This is just an arbitrary numerically incrementing counter and we <em>don’t</em> want to use this in building a model!</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-29_3f399826340f6e7fc984846afe92a23f">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Run the pipeline successfully first before you reassign!</span></span>
<span><span class="co"># Samples with known outcomes used for model training.</span></span>
<span><span class="va">known</span> <span class="op">&lt;-</span> <span class="va">fluimp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">case_id</span><span class="op">)</span></span>
<span><span class="va">known</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="a-note-on-reproducibility-and-set.seed" class="level4" data-number="10.1.7.2"><h4 data-number="10.1.7.2" class="anchored" data-anchor-id="a-note-on-reproducibility-and-set.seed">
<span class="header-section-number">10.1.7.2</span> A note on reproducibility and <code>set.seed()</code>
</h4>
<p>When we train a model using resampling, that sampling is going to happen <em>pseudo</em>-randomly. Try running this function which generates five numbers from a random uniform distribution between 0 and 1.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-30_9af6da08259756a68074f154954bd1a0">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you run that function over and over again, you’ll get different results. But, we can set the random number seed generator with any value we choose, and we’ll get the same result. Try setting the seed, drawing the random numbers, then re-setting the same seed, and re-running the <code>runif</code> function again. You should get identical results.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-31_462666ce811619762dab1bd20332719a">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">22908</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Eventually I’m going to compare different models to each other, so I want to set the random number seed generator to the same value for each model so the same random bootstrap samples are identical across models.</p>
</section><section id="random-forest" class="level4" data-number="10.1.7.3"><h4 data-number="10.1.7.3" class="anchored" data-anchor-id="random-forest">
<span class="header-section-number">10.1.7.3</span> Random Forest</h4>
<p>Let’s fit a <a href="https://en.wikipedia.org/wiki/Random_forest">random forest</a> model. See the help for <code><a href="https://rdrr.io/pkg/caret/man/train.html">?train</a></code> and click on the link therein to see what abbreviations correspond to which model. First set the random number seed generator to some number, e.g., 8382, that we’ll use for all other models we make. The model forumula here takes the know data, and the <code>responseVar~.</code> syntax says “predict <code>responseVar</code> using every other variable in the data.” Finally, notice how when we call <code><a href="https://rdrr.io/pkg/caret/man/train.html">train()</a></code> from the <strong>caret</strong> package using “rf” as the type of model, it automatically loads the <strong><a href="https://cran.r-project.org/package=randomForest">randomForest</a></strong> package that you installed. If you didn’t have it installed, it would probably ask you to install it first.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-32_57ed556a19110fc25bbd30b38a38e094">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set the random number seed generator</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8382</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit a random forest model for outcome against everything in the model (~.)</span></span>
<span><span class="va">modrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">~</span><span class="va">.</span>, data<span class="op">=</span><span class="va">known</span>, method<span class="op">=</span><span class="st">"rf"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Take a look at the output</span></span>
<span><span class="va">modrf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest 

77 samples
10 predictors
 2 classes: 'Death', 'Recover' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 77, 77, 77, 77, 77, 77, ... 
Resampling results across tuning parameters:

  mtry  Accuracy  Kappa
   2    0.688     0.328
   6    0.684     0.322
  10    0.693     0.345

Accuracy was used to select the optimal model using the largest value.
The final value used for the model was mtry = 10.</code></pre>
</div>
</div>
<p>Take a look at what that tells us. It tells us it’s fitting a Random Forest model using 77 samples, predicting a categorical outcome class (Death or Recover) based on 10 predictors. It’s not doing any pre-processing like centering or scaling, and it’s doing bootstrap resampling of 77 samples with replacement, repeated 25 times each. Random Forest has a single tuning parameter, <span class="math inline">\(m_{\text{try}}\)</span> – the algorithm will select <span class="math inline">\(m_{\text{try}}\)</span> number of predictors to attempt a split for classification when building a classification tree. The caret package does 25 bootstrap resamples for different values of <span class="math inline">\(m_{\text{try}}\)</span> (you can also control this too if you want), and computes <a href="https://en.wikipedia.org/wiki/Sensitivity_and_specificity#Confusion_matrix">accuracy</a> and <a href="https://en.wikipedia.org/wiki/Cohen%27s_kappa">kappa</a> measures of performance on the held-out samples.</p>
<p>Accuracy is the number of true assignments to the correct class divided by the total number of samples. <a href="https://en.wikipedia.org/wiki/Cohen%27s_kappa">Kappa</a> takes into account the expected accuracy while considering chance agreement, and is useful for extremely imbalanced class distributions. For continuous outcomes, you can measure things like RMSE or correlation coefficients.</p>
<blockquote class="blockquote">
<p><strong><em>A bit about random forests.</em></strong> Random forests are an ensemble learning approach based on classification trees. The CART (classification and regression tree) method searches through all available predictors to try to find a value of a single variable that splits the data into two groups by minimizing the impurity of the outcome between the two groups. The process is repeated over and over again until a hierarchical (tree) structure is created. But trees don’t have great performance (prediction accuracy) compared to other models. Small changes in the data can drastically affect the structure of the tree.</p>
<p>Tree algorithms are improved by ensemble approaches - instead of growing a single tree, grow many trees and aggregate (majority vote or averaging) the predictions made by the ensemble. The random forest algorithm is essentially:</p>
<ol type="1">
<li>From the training data of <em>n</em> samples, draw a bootstrap sample of size <em>n</em>.</li>
<li>For each bootstrap sample, grow a classification tree, but with a small modification compared to the traditional algorithm: instead of selecting from all possible predictor variables to form a split, choose the best split among a randomly selected subset of <span class="math inline">\(m_{\text{try}}\)</span> predictors. Here, <span class="math inline">\(m_{\text{try}}\)</span> is the only tuning parameter. The trees are grown to their maximum size and not “pruned” back.</li>
<li>Repeat the steps agove until a large number of trees is grown.</li>
<li>Estimate the performance of the ensemble of trees using the “out-of-bag” samples - i.e., those that were never selected during the bootstrap procedure in step #1.</li>
<li>Estimate the importance of each variable in the model by randomly permuting each predictor variable in testing on the out-of-bag samples. If a predictor is important, prediction accuracy will degrade. If the predictor isn’t that helpful, performance doesn’t deteriorate as much.</li>
</ol>
<p>Random forests are efficient compared to growing a single tree. For one, the RF algorithm only selects from <span class="math inline">\(m_{\text{try}}\)</span> predictors at each step, rather than all available predictors. Usually <span class="math inline">\(m_{\text{try}}\)</span> is by default somewhere close to the square root of the total number of available predictors, so the search is very fast. Second, while the traditional CART tree algorithm has to go through extensive cross-validation based pruning to avoid overfitting, the RF algorithm doesn’t do any pruning at all. In fact, building an RF model <em>can</em> be faster than building a single tree!</p>
</blockquote>
<p>Caret also provides a function for <a href="http://topepo.github.io/caret/variable-importance.html">assessing the importance of each variable</a>. The <code>varImp</code> function knows what kind of model was fitted and knows how to estimate variable importance. For Random Forest, it’s an estimate of how much worse the prediction gets after randomly shuffling the values of each predictor variable in turn. A variable that’s important will result in a much worse prediction than a variable that’s not as meaningful.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-33_33f24725beeb7f41de84658e286506b3">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">modrf</span>, scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>rf variable importance

                 Overall
age              100.000
days_to_outcome   60.642
days_to_hospital  38.333
early_outcome     36.591
Other             15.772
hospital           8.410
male               3.758
Shanghai           1.687
Jiangsu            0.133
Zhejiang           0.000</code></pre>
</div>
</div>
<p>You can also pass that whole thing to <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>, or wrap the statement in <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>, to see a graphical representation.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-34_c763927e469d04f0d3283e56c526bfe1">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">modrf</span>, scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="stochastic-gradient-boosting" class="level4" data-number="10.1.7.4"><h4 data-number="10.1.7.4" class="anchored" data-anchor-id="stochastic-gradient-boosting">
<span class="header-section-number">10.1.7.4</span> Stochastic Gradient Boosting</h4>
<p>Let’s try a different method, <a href="https://en.wikipedia.org/wiki/Gradient_boosting">stochastic gradient boosting</a>, which uses a different method for building an ensemble of classification trees (see <a href="https://quantdare.com/what-is-the-difference-between-bagging-and-boosting/">this post</a> for a discussion of bagging vs boosting). This requires the <strong><a href="https://cran.r-project.org/package=gbm">gbm</a></strong> package. Again, set the random seed generator.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-35_8bab94003a7eabcef441900d50458835">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8382</span><span class="op">)</span></span>
<span><span class="va">modgbm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">~</span><span class="va">.</span>, data<span class="op">=</span><span class="va">known</span>, method<span class="op">=</span><span class="st">"gbm"</span>, verbose<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">modgbm</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stochastic Gradient Boosting 

77 samples
10 predictors
 2 classes: 'Death', 'Recover' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 77, 77, 77, 77, 77, 77, ... 
Resampling results across tuning parameters:

  interaction.depth  n.trees  Accuracy  Kappa
  1                   50      0.630     0.210
  1                  100      0.627     0.210
  1                  150      0.630     0.213
  2                   50      0.633     0.222
  2                  100      0.636     0.218
  2                  150      0.632     0.208
  3                   50      0.616     0.188
  3                  100      0.639     0.227
  3                  150      0.636     0.218

Tuning parameter 'shrinkage' was held constant at a value of 0.1

Tuning parameter 'n.minobsinnode' was held constant at a value of 10
Accuracy was used to select the optimal model using the largest value.
The final values used for the model were n.trees = 100, interaction.depth =
 3, shrinkage = 0.1 and n.minobsinnode = 10.</code></pre>
</div>
</div>
<p>Notice how stochastic gradient boosting has two different tuning parameters - interaction depth and n trees. There were others (shrinkage, and <code>n.minobsinnode</code>) that were held constant. The caret package automates the bootstrap resampling based performance assessment across all combinations of depth and ntrees, and it tells you where you got the best performance. Notice that the performance here doesn’t seem to be as good as random forest. We can also look at variable importance here too, and see similar rankings.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-36_648c2cc4794c1f569c4ef1caf336cadf">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gbm-developers/gbm">gbm</a></span><span class="op">)</span> <span class="co"># needed because new version of caret doesn't load</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">modgbm</span>, scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/varImp.html">varImp</a></span><span class="op">(</span><span class="va">modgbm</span>, scale<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="model-comparison-random-forest-vs-gradient-boosting" class="level4" data-number="10.1.7.5"><h4 data-number="10.1.7.5" class="anchored" data-anchor-id="model-comparison-random-forest-vs-gradient-boosting">
<span class="header-section-number">10.1.7.5</span> Model comparison: Random Forest vs Gradient Boosting</h4>
<p>Let’s compare those two models. Because the random seed was set to the same number (8382), the bootstrap resamples were identical across each model. Let’s directly compare the results for the best models from each method.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-37_972365749eba6d79b14cf8835d767add">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">modsum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/resamples.html">resamples</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gbm<span class="op">=</span><span class="va">modgbm</span>, rf<span class="op">=</span><span class="va">modrf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">modsum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
summary.resamples(object = modsum)

Models: gbm, rf 
Number of resamples: 25 

Accuracy 
     Min. 1st Qu. Median  Mean 3rd Qu.  Max. NA's
gbm 0.483   0.577  0.625 0.639   0.692 0.812    0
rf  0.552   0.654  0.692 0.693   0.731 0.864    0

Kappa 
       Min. 1st Qu. Median  Mean 3rd Qu.  Max. NA's
gbm -0.1600   0.103  0.250 0.227   0.319 0.591    0
rf  -0.0162   0.255  0.366 0.345   0.421 0.697    0</code></pre>
</div>
</div>
<p>It appears that random forest is doing much better in terms of both accuracy and kappa. Let’s train a few other types of models.</p>
</section><section id="elastic-net-regularized-logistic-regression" class="level4" data-number="10.1.7.6"><h4 data-number="10.1.7.6" class="anchored" data-anchor-id="elastic-net-regularized-logistic-regression">
<span class="header-section-number">10.1.7.6</span> Elastic net regularized logistic regression</h4>
<p><a href="https://en.wikipedia.org/wiki/Elastic_net_regularization">Elastic net regularization</a> is a method that combines both the <a href="https://en.wikipedia.org/wiki/Lasso_(statistics)">lasso</a> and <a href="https://en.wikipedia.org/wiki/Tikhonov_regularization">ridge</a> methods of reguarizing a model. <a href="https://en.wikipedia.org/wiki/Regularization_(mathematics)">Regularization</a> is a method for <em>penalizing</em> a model as it gains complexity with more predictors in an attempt to avoid overfitting. You’ll need the <strong><a href="https://cran.r-project.org/package=glmnet">glmnet</a></strong> package for this.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-38_4acc3052809ca3c29a6fa297a73bb289">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8382</span><span class="op">)</span></span>
<span><span class="va">modglmnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">~</span><span class="va">.</span>, data<span class="op">=</span><span class="va">known</span>, method<span class="op">=</span><span class="st">"glmnet"</span><span class="op">)</span></span>
<span><span class="va">modglmnet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>glmnet 

77 samples
10 predictors
 2 classes: 'Death', 'Recover' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 77, 77, 77, 77, 77, 77, ... 
Resampling results across tuning parameters:

  alpha  lambda    Accuracy  Kappa
  0.10   0.000391  0.635     0.226
  0.10   0.003908  0.634     0.226
  0.10   0.039077  0.630     0.217
  0.55   0.000391  0.635     0.226
  0.55   0.003908  0.633     0.223
  0.55   0.039077  0.633     0.226
  1.00   0.000391  0.635     0.226
  1.00   0.003908  0.630     0.215
  1.00   0.039077  0.643     0.243

Accuracy was used to select the optimal model using the largest value.
The final values used for the model were alpha = 1 and lambda = 0.0391.</code></pre>
</div>
</div>
</section><section id="k-nearest-neighbor" class="level4" data-number="10.1.7.7"><h4 data-number="10.1.7.7" class="anchored" data-anchor-id="k-nearest-neighbor">
<span class="header-section-number">10.1.7.7</span> k-nearest neighbor</h4>
<p><a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm">k-nearest neighbor</a> attempts to assign samples to their closest labeled neighbors in high-dimensional space. You’ll need the <strong><a href="https://cran.r-project.org/package=kknn">kknn</a></strong> package for this.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-39_328b2a2822aebcd3fe7230e2322946dc">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">8382</span><span class="op">)</span></span>
<span><span class="va">modknn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html">train</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">~</span><span class="va">.</span>, data<span class="op">=</span><span class="va">known</span>, method<span class="op">=</span><span class="st">"kknn"</span><span class="op">)</span></span>
<span><span class="va">modknn</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>k-Nearest Neighbors 

77 samples
10 predictors
 2 classes: 'Death', 'Recover' 

No pre-processing
Resampling: Bootstrapped (25 reps) 
Summary of sample sizes: 77, 77, 77, 77, 77, 77, ... 
Resampling results across tuning parameters:

  kmax  Accuracy  Kappa
  5     0.635     0.218
  7     0.635     0.218
  9     0.633     0.214

Tuning parameter 'distance' was held constant at a value of 2
Tuning
 parameter 'kernel' was held constant at a value of optimal
Accuracy was used to select the optimal model using the largest value.
The final values used for the model were kmax = 7, distance = 2 and kernel
 = optimal.</code></pre>
</div>
</div>
</section><section id="compare-all-the-models" class="level4" data-number="10.1.7.8"><h4 data-number="10.1.7.8" class="anchored" data-anchor-id="compare-all-the-models">
<span class="header-section-number">10.1.7.8</span> Compare all the models</h4>
<p>Now let’s look at the performance characteristics for the best performing model across all four types of models we produced. It still looks like random forest is coming through as the winner.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-40_16d0e7cca00d23469987b761dcbf7089">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">modsum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/caret/man/resamples.html">resamples</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>gbm<span class="op">=</span><span class="va">modgbm</span>, rf<span class="op">=</span><span class="va">modrf</span>, glmnet<span class="op">=</span><span class="va">modglmnet</span>, knn<span class="op">=</span><span class="va">modknn</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">modsum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
summary.resamples(object = modsum)

Models: gbm, rf, glmnet, knn 
Number of resamples: 25 

Accuracy 
        Min. 1st Qu. Median  Mean 3rd Qu.  Max. NA's
gbm    0.483   0.577  0.625 0.639   0.692 0.812    0
rf     0.552   0.654  0.692 0.693   0.731 0.864    0
glmnet 0.467   0.615  0.654 0.643   0.692 0.773    0
knn    0.452   0.586  0.615 0.635   0.667 0.818    0

Kappa 
          Min. 1st Qu. Median  Mean 3rd Qu.  Max. NA's
gbm    -0.1600   0.103  0.250 0.227   0.319 0.591    0
rf     -0.0162   0.255  0.366 0.345   0.421 0.697    0
glmnet -0.0284   0.150  0.267 0.243   0.319 0.538    0
knn    -0.2760   0.143  0.199 0.218   0.318 0.627    0</code></pre>
</div>
</div>
<p>The <code><a href="https://rdrr.io/pkg/lattice/man/xyplot.html">bwplot()</a></code> function can take this model summary object and visualize it.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-41_420c987c8323add3964327eee081176e">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html">bwplot</a></span><span class="op">(</span><span class="va">modsum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section></section><section id="prediction-on-unknown-samples" class="level3" data-number="10.1.8"><h3 data-number="10.1.8" class="anchored" data-anchor-id="prediction-on-unknown-samples">
<span class="header-section-number">10.1.8</span> Prediction on unknown samples</h3>
<p>Once we have a model trained it’s fairly simple to predict the class of the unknown samples. Take a look at the unknown data again:</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-42_394ed63d84b97dde0e70adbb3019ac80">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unknown</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, since Random Forest worked best, let’s use that model to predict the outcome!</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-43_f944e333bc9fe167e3039b053f16bbfd">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modrf</span>, newdata<span class="op">=</span><span class="va">unknown</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] Recover Recover Death   Recover Death   Death   Recover Recover Death  
[10] Recover Death   Recover Recover Recover Recover Death   Recover Death  
[19] Death   Death   Recover Recover Recover Recover Recover Recover Recover
[28] Recover Death   Death   Recover Recover Recover Recover Recover Recover
[37] Recover Recover Recover Recover Recover Recover Recover Death   Recover
[46] Death   Recover Death   Recover Recover Recover Recover Recover Recover
[55] Recover Recover Recover
Levels: Death Recover</code></pre>
</div>
</div>
<p>This gives you a vector of values that would be the outcome for the individuals in the <code>unknown</code> dataset. From here it’s pretty simple to put them back in the data with a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-44_d960b9a28a4287ee2a6a15115de73b6d">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unknown</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>outcome<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modrf</span>, newdata<span class="op">=</span><span class="va">unknown</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 57 × 12
   case_id outcome   age  male hospital days_to_hospital days_to_outcome
   &lt;chr&gt;   &lt;fct&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;
 1 case_4  Recover    18     0        1                8              46
 2 case_9  Recover    39     1        1                0              18
 3 case_15 Death      34     0        0               11              38
 4 case_16 Recover    51     1        0                3              20
 5 case_22 Death      56     1        1                4              17
 6 case_28 Death      51     1        0                6               6
 7 case_31 Recover    43     1        0                4              21
 8 case_32 Recover    46     1        0                3              20
 9 case_38 Death      28     1        0                2               7
10 case_39 Recover    38     1        1                0              18
# ℹ 47 more rows
# ℹ 5 more variables: early_outcome &lt;dbl&gt;, Jiangsu &lt;dbl&gt;, Other &lt;dbl&gt;,
#   Shanghai &lt;dbl&gt;, Zhejiang &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Alternatively, you could pass in <code>type="prob"</code> to get prediction probabilities instead of predicted classes.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-45_1dee07b0a5e874cb42a03d86a3cf8f81">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">modrf</span>, newdata<span class="op">=</span><span class="va">unknown</span>, type<span class="op">=</span><span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Death Recover
1 0.040   0.960
2 0.030   0.970
3 0.564   0.436
4 0.138   0.862
5 0.774   0.226
6 0.972   0.028</code></pre>
</div>
</div>
<p>You could also imagine going further to get the prediction probabilities out of each type of model we made. You could add up the prediction probabilities for Death and Recovery for each individual across model types, and then compute a ratio. If across all the models that ratio is, for example, 2x in favor of death, you could predict death, or if it’s 2x in favor of recovery, you predict recover, and if it’s in between, you might call it “uncertain.” This lets you not only reap the advantages of ensemble learning within a single algorithm, but also lets you use information across a variety of different algorithm types.</p>
</section></section><section id="forecasting" class="level2" data-number="10.2"><h2 data-number="10.2" class="anchored" data-anchor-id="forecasting">
<span class="header-section-number">10.2</span> Forecasting</h2>
<section id="the-prophet-package" class="level3" data-number="10.2.1"><h3 data-number="10.2.1" class="anchored" data-anchor-id="the-prophet-package">
<span class="header-section-number">10.2.1</span> The Prophet Package</h3>
<p>Forecasting is a common data science task that helps with things like capacity planning, goal setting, anomaly detection, and resource use projection. Forecasting can involve complex models, where overly simplistic models can be brittle and can be too inflexible to incorporate useful assumptions about the underlying data.</p>
<p>Recently, the data science team at Facebook released as open-source a tool they developed for forecasting, called <strong>prophet</strong>, as both an R and python package.</p>
<!-- - Release blog post: https://research.fb.com/prophet-forecasting-at-scale/ -->
<ul>
<li>Paper (preprint): https://peerj.com/preprints/3190/</li>
<li>Project homepage: https://facebook.github.io/prophet/</li>
<li>Documentation: https://facebook.github.io/prophet/docs/quick_start.html</li>
<li>R package: https://cran.r-project.org/web/packages/prophet/index.html</li>
<li>Python package: https://pypi.python.org/pypi/fbprophet/</li>
<li>Source code: https://github.com/facebook/prophet</li>
</ul>
<p><small></small></p>
<blockquote class="blockquote">
<p>Google and Twitter have released as open-source similar packages: Google’s <strong>CausalImpact</strong> software (<a href="https://google.github.io/CausalImpact/" class="uri">https://google.github.io/CausalImpact/</a>) assists with inferring causal effects of a design intervention on a time series, and Twitter’s <strong>AnomalyDetection</strong> package (<a href="https://github.com/twitter/AnomalyDetection" class="uri">https://github.com/twitter/AnomalyDetection</a>) was designed to detect blips and anomalies in time series data given the presence of seasonality and underlying trends. See also Rob Hyndman’s <strong><a href="https://cran.r-project.org/package=forecast">forecast</a></strong> package in R.</p>
</blockquote>
<p></p>
<p>Prophet is optimized for forecasting problems that have the following characteristics:</p>
<ul>
<li>Hourly, daily, or weekly observations with at least a few months (preferably a year) of history</li>
<li>Strong multiple “human-scale” seasonalities: day of week and time of year</li>
<li>Important holidays that occur at irregular intervals that are known in advance (e.g.&nbsp;the Super Bowl)</li>
<li>A reasonable number of missing observations or large outliers</li>
<li>Historical trend changes, for instance due to product launches or logging changes</li>
<li>Trends that are non-linear growth curves, where a trend hits a natural limit or saturates</li>
</ul>
<p>These use cases are optimized for business forecasting problems encountered at Facebook, but many of the characteristics here apply well to other kinds of forecasting problems. Further, while the default settings can produce fairly high-quality forecasts, if the results aren’t satisfactory, you aren’t stuck with a completely automated model you can’t change. The prophet package allows you to tweak forecasts using different parameters. The process is summarized in the figure below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="img/prophet.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption"><em>Schematic view of the analyst-in-the-loop approach to forecasting at scale, which best makes use of human and automated tasks. Image from the Prophet preprint noted above.</em></figcaption><p></p>
</figure>
</div>
<p><strong><a href="https://cran.r-project.org/package=prophet">Prophet</a></strong> is a good replacement for the <strong><a href="https://cran.r-project.org/package=forecast">forecast</a></strong> package because:</p>
<ol type="1">
<li>
<strong>Prophet makes it easy.</strong> The forecast package offers many different techniques, each with their own strengths, weaknesses, and tuning parameters. While the choice of parameter settings and model specification gives the expert user great flexibility, the downside is that choosing the wrong parameters as a non-expert can give you poor results. Prophet’s defaults work pretty well.</li>
<li>
<strong>Prophet’s forecasts are intuitively customizable.</strong> You can choose smoothing parameters for seasonality that adjust how closely you fit historical cycles, and you can adjust how agressively to follow historical trend changes. You can manually specify the upper limit on growth curves, which allows for you to supplement the automatic forecast with your own prior information about how your forecast will grow (or decline). You can also specify irregular events or time points (e.g., election day, the Super Bowl, holiday travel times, etc) that can result in outlying data points.</li>
</ol>
<p>The prophet procedure is essentially a regression model with some additional components:</p>
<ol type="1">
<li>A piecewise linear or logistic growth curve trend. Prophet automatically detects changes in trends by selecting changepoints from the data.</li>
<li>A yearly seasonal component modeled using Fourier series.</li>
<li>A weekly seasonal component using dummy variables.</li>
<li>A user-provided list of important holidays.</li>
</ol>
<p>See the prophet preprint for more.</p>
<blockquote class="blockquote">
<p>Taylor SJ, Letham B. (2017) Forecasting at scale. <em>PeerJ Preprints</em> 5:e3190v2 https://doi.org/10.7287/peerj.preprints.3190v2</p>
</blockquote>
</section><section id="cdc-ili-time-series-data" class="level3" data-number="10.2.2"><h3 data-number="10.2.2" class="anchored" data-anchor-id="cdc-ili-time-series-data">
<span class="header-section-number">10.2.2</span> CDC ILI time series data</h3>
<p>Here we’re going to use historical flu tracking data from the CDC’s U.S. Outpatient <a href="https://wwwn.cdc.gov/ilinet/">Influenza-like Illness Surveillance Network</a> along with data from the <a href="https://gis.cdc.gov/grasp/fluview/mortality.html">National Center for Health Statistics (NCHS) Mortality Surveillance System</a>. This contains ILI totals from CDC and flu + pneumonia death data from NCHS through the end of October 2017. It’s the <strong><a href="data/ilinet.csv">ilinet.csv</a></strong> file. Let’s read it in, then take a look. Notice that <code>week_start</code> was automatically read in as a date data type. What you see as <code>2003-01-06</code> is actually represented internally as a date, not a character.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-47_163e08687e4b0c38276cf7d5623769f0">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Read in the ILI data.</span></span>
<span><span class="va">ili</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/ilinet.csv"</span><span class="op">)</span></span>
<span><span class="va">ili</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 818 × 6
   week_start ilitotal total_patients fludeaths pneumoniadeaths all_deaths
   &lt;date&gt;        &lt;dbl&gt;          &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;
 1 2003-01-06     3260         171193        NA              NA         NA
 2 2003-01-13     3729         234513        NA              NA         NA
 3 2003-01-20     4204         231550        NA              NA         NA
 4 2003-01-27     5696         235566        NA              NA         NA
 5 2003-02-03     7079         246969        NA              NA         NA
 6 2003-02-10     7782         245751        NA              NA         NA
 7 2003-02-17     7649         253656        NA              NA         NA
 8 2003-02-24     7228         241110        NA              NA         NA
 9 2003-03-03     5606         241683        NA              NA         NA
10 2003-03-10     4450         228549        NA              NA         NA
# ℹ 808 more rows</code></pre>
</div>
</div>
<p>We have information on ILI frequency since January 2003, but we don’t have information on death data until 2009. From here, we have data up through the end of September 2018.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-48_b26efc07ffe71f47a373b1bf15dcc782">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">ili</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  week_start ilitotal total_patients fludeaths pneumoniadeaths all_deaths
  &lt;date&gt;        &lt;dbl&gt;          &lt;dbl&gt;     &lt;dbl&gt;           &lt;dbl&gt;      &lt;dbl&gt;
1 2018-08-20     6519         798422         9            2426      46033
2 2018-08-27     7257         762601         5            2321      45679
3 2018-09-03     8049         823571         4            2430      44689
4 2018-09-10     9457         821290         7            2329      44279
5 2018-09-17     9966         858050         7            2239      41875
6 2018-09-24    11057         832495         6            1896      35305</code></pre>
</div>
</div>
</section><section id="forecasting-with-prophet" class="level3" data-number="10.2.3"><h3 data-number="10.2.3" class="anchored" data-anchor-id="forecasting-with-prophet">
<span class="header-section-number">10.2.3</span> Forecasting with prophet</h3>
<p>Let’s load the prophet library then take a look at the help for <code><a href="https://rdrr.io/pkg/prophet/man/prophet.html">?prophet</a></code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-49_5c463d8c404773a2a3fa50489f711c8b">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/facebook/prophet">prophet</a></span><span class="op">)</span></span>
<span><span class="co"># ?prophet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The help tells you that prophet requires a data frame containing columns named <code>ds</code> of type date and <code>y</code>, containing the time series data. Many other options are available. Let’s start with the data, select <code>week_start</code> calling it <code>ds</code>, and <code>ilitotal</code> calling it <code>y</code>.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-50_183c04d1c57e097e4391b822a3cc375c">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ili</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">week_start</span>, <span class="va">ilitotal</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ili</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ds<span class="op">=</span><span class="va">week_start</span>, y<span class="op">=</span><span class="va">ilitotal</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we do that, we can simply pipe this to <code><a href="https://rdrr.io/pkg/prophet/man/prophet.html">prophet()</a></code> to produce the prophet forecast model.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-51_54856f73395ece7014dbb55a4dbc3892">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pmod</span> <span class="op">&lt;-</span> <span class="va">ili</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ds<span class="op">=</span><span class="va">week_start</span>, y<span class="op">=</span><span class="va">ilitotal</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/prophet/man/prophet.html">prophet</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s make a “future” dataset to use to predict. Looking at <code><a href="https://rdrr.io/pkg/prophet/man/make_future_dataframe.html">?make_future_dataframe</a></code> will tell you that this function takes the prophet model and the number of days forward to project.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-52_251c8d34fbaf2e4ae328cc7a12012aeb">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">future</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/prophet/man/make_future_dataframe.html">make_future_dataframe</a></span><span class="op">(</span><span class="va">pmod</span>, periods<span class="op">=</span><span class="fl">365</span><span class="op">*</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">future</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, let’s forecast the future! Take a look - the <code>yhat</code>, <code>yhat_lower</code>, and <code>yhat_upper</code> columns are the predictions, lower, and upper confidence bounds. There are additional columns for seasonal and yearly trend effects.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-53_7b589e73933df90548d0b7b2dabbe905">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">pmod</span>, <span class="va">future</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">forecast</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we pass the prophet model and the forecast into the generic <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> function, it knows what kind of objects are being passed, and will visualize the data appropriately.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-54_ec8129b28fa1266b1f1fec47734dbd29">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pmod</span>, <span class="va">forecast</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Five year ILI forecast"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You can also use the <code>prophet_plot_components</code> function to see the forecast broken down into trend and yearly seasonality. We see an inflection point around 2010 where ILI reports seem to stop rising – if you go back to the previous plot you’ll see it there too. Perhaps this is due to a change in surveillance or reporting strategy. You also see the yearly trend, which makes sense for flu outbreaks. You also noticed that when we originally fit the model, daily and weekly seasonality was disabled. This makes sense for broad time-scale things like influenza surveillance over decades, but you might enable it for more granular time-series data.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-55_035f7a46077fc3bb2adb2dcbd5313267">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/prophet/man/prophet_plot_components.html">prophet_plot_components</a></span><span class="op">(</span><span class="va">pmod</span>, <span class="va">forecast</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Try it with the flu death data. Look at both flu deaths and pneumonia deaths. First, limit the data frame to only include the latter portion where we have death surveillance data. Then use the same procedure.</p>
<div class="cell" data-hash="predmodeling_cache/html/unnamed-chunk-56_063095b5bad44aa4d4b436fc9a429b40">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pmod</span> <span class="op">&lt;-</span> <span class="va">ili</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">pneumoniadeaths</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>ds<span class="op">=</span><span class="va">week_start</span>, y<span class="op">=</span><span class="va">pneumoniadeaths</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/prophet/man/prophet.html">prophet</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">future</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/prophet/man/make_future_dataframe.html">make_future_dataframe</a></span><span class="op">(</span><span class="va">pmod</span>, periods<span class="op">=</span><span class="fl">365</span><span class="op">*</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">pmod</span>, <span class="va">future</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pmod</span>, <span class="va">forecast</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Five year pneumonia death forecast"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="predmodeling_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>See the prophet preprint for more.</p>
<blockquote class="blockquote">
<p>Taylor SJ, Letham B. (2017) Forecasting at scale. <em>PeerJ Preprints</em> 5:e3190v2 https://doi.org/10.7287/peerj.preprints.3190v2</p>
</blockquote>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./survival.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Survival Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./textmining.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Text Mining and NLP</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">© 2018 Stephen D. Turner, Ph.D.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://x.com/strnr">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/stephenturner">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/turnersd/">
      <i class="bi bi-linkedin" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://stephenturner.us/">
      <i class="bi bi-house-fill" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://blog.stephenturner.us/">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>